<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <title>Vellum Test</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    

    <!-- Mocha and test-only dependencies -->
    <link href="../node_modules/mocha/mocha.css" type="text/css" rel="stylesheet"></link>
    <script src="../node_modules/mocha/mocha.js"></script>
    <script src="../bower_components/chai/chai.js"></script>
    <script src="../bower_components/sinonjs/sinon.js"></script>

    <script src="../bower_components/equivalent-xml-js/src/equivalent-xml.js"></script>
    <script src="../bower_components/jquery.ui/tests/jquery.simulate.js"></script>
    <script src="utils.js"></script>


    <!-- Runtime Dependencies -->
    <link href="lib/hqstyle-core.css" type="text/css" rel="stylesheet"></link>
    <!--<script src="../src/js/saveButton.js"></script>-->
    
    <!-- Vellum -->
    <script src="../bower_components/requirejs/require.js"></script>
    <script>
        require.config({
            baseUrl: '../src'
        });
    </script>
</head>

<body>
    <ul class="nav nav-tabs">
      <li class="active"><a data-toggle='tab' href="#vellum">Vellum</a></li>
      <li><a data-toggle='tab' href="#vellum_results">Test Results</a></li>

      <button id="run-tests" class="btn pull-right">Run Tests</button>
    </ul>

    <div class="tab-content">
        <div class="tab-pane active" id="vellum"><div id="formdesigner"></div></div>
        <div class="tab-pane" id="vellum_results"><div id="mocha"></div></div>
    </div>
    
    <!-- Tests and running -->
    <script type="text/javascript">
        mocha.setup('bdd');
        mocha.reporter('html');

        var TEST_INSTANCE_CONFIG = [
            {
                name: "All Cases",
                sourceUri: "jr://instance/casedb",
                defaultId: "casedb",
                rootNodeName: "casedb",
                levels: [
                    {
                        nodeName: "case",
                        properties: [
                            {
                                id: 'case_name'
                            },
                            {
                                id: '@case_id'
                            }
                        ],
                        subsets: [
                            {
                                name: "mother Cases",
                                selector: "@case_type='mother'",
                                properties: [
                                    {
                                        id: 'edd' 
                                    }
                                ]
                            },
                            {
                                name: "child Cases",
                                selector: "@case_type = 'child'",
                                properties: [
                                    {
                                        id: 'dob'
                                    }
                                ]
                            }
                        ]
                    }
                ],
            },
            {
                name: "Some Fixture",
                sourceUri: "jr://fixture/some-fixture",
                defaultId: "somefixture",
                rootNodeName: "foos",
                levels: [
                    {
                        nodeName: "foo",
                        subsets: [
                            {
                                name: "woos",
                                selector: "@foo_type=\"woo\""
                            }
                        ]
                    },
                    {
                        nodeName: "bar",
                        subsets: [
                            {
                                name: "eggs",
                                selector: "@bar_type='eggs'"
                            }
                        ]
                    }
                ]
            }
        ];

        require(["main"], function ($) {
            $("#formdesigner").vellum({
                core: {
                    formName: "Untitled Form",
                    allowedDataNodeReferences: [
                        "meta/deviceID",
                        "meta/instanceID",
                        "meta/username",
                        "meta/userID",
                        "meta/timeStart",
                        "meta/timeEnd"
                    ],
                    externalInstances: TEST_INSTANCE_CONFIG,
                },
                javaRosa: {
                    langs: ['en', 'hin'],
                    displayLanguage: 'en'
                },
            });

            function runTests() {
                $("#run-tests").addClass('disabled').attr('disabled', true);
                if (window.mochaPhantomJS) { 
                    mochaPhantomJS.run(); 
                } else { 
                    mocha.run()
                };
            }

            $("#run-tests").click(runTests);

            if (window.mochaPhantomJS) {
                $("#run-tests").click();
            }
        });
    </script>

    <script src="formdesigner.ignoreButRetain.js"></script>
    <script src="formdesigner.lock.js"></script>
    <script src="itemset.js"></script>
  </body>
</html>
